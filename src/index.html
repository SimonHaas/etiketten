<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Etiketten</title>
    <link rel="stylesheet" href="thirdparty/bootstrap.min.css"/>
    <link rel="manifest" href="/manifest.json" />
  </head>
  <body>
    <div class="container">
      <h1>TEST</h1>
      <div class="row">
        <div class="col-sm">
          <h2 id="large">groß</h2>
        </div>
        <div class="col-sm">
          <h2 id="small">klein</h2>
        </div>
      </div>
    </div>
    <script src="thirdparty/jquery.min.js"></script>
    <script>
      const SMALL = 'small';
      const LARGE = 'large';

      const W200 = 200;
      const W250 = 250;
      const W300 = 300;

      const PRODUCTS = {
        leberwurst: {
          prefix: "Hausgemachte",
          ingredients:
            "70% Schweinefleisch, 15% Schweineleber, Schwarten, Kochsalz, Zwiebeln, Gewürze (u.a. SELLERIE), Geschmacksverstärker: Natriumglutamat",
          name: "Bauernleberwurst",
          good_for: 7,
          sizes: [
            {
              labelSize: SMALL,
              weight: W250,
            },
          ]
        },
        bierschinken: {
          prefix: "Hausgemachter",
          ingredients:
            "70% Schweinefleisch, 10% Rindfleisch, Trinkwasser, Nitritpökelsalz (Kochsalz, Konservierungsstoff E250), Gewürze u.a. SELLERIE, Stabilisator: Phosphat, Geschmacksverstärker: Natriumglutamat",
          name: "Bierschinken",
          good_for: 7,
          sizes: [
            {
              labelSize: SMALL,
              weight: W250,
            },
            {
              labelSize: LARGE,
              weight: W300,
            },
          ]
        },
        bratwurst: {
          prefix: "Hausgemachtes",
          ingredients:
            "80% Schweinefleisch, Trinkwasser, Kochsalz, Gewürze (u.a. SELLERIE), Geschmacksverstärker: Natriumglutamat, Stabilisator: Phosphat",
          name: "Bratwurstbrät",
          good_for: 7,
          sizes: [
            {
              labelSize: SMALL,
              weight: W250,
            },
            {
              labelSize: LARGE,
              weight: W300,
            },
          ]
        },
        goettinger: {
          prefix: "Hausgemachte",
          ingredients:
            "50% Schweinefleisch, 30% Rindfleisch, Trinkwasser, Nitritpökelsalz (Kochsalz, Konservierungsstoff E250), Gewürze u.a. SELLERIE, Stabilisator: Phosphat, Geschmacksverstärker: Natriumglutamat",
          name: "Göttinger",
          good_for: 7,
          sizes: [
            SMALL,
            LARGE,
          ]
        },
        grobebauernwurst: {
          prefix: "Hausgemachte",
          ingredients:
            "70% Schweinefleisch, 10% Rindfleisch, Trinkwasser, Nitritpökelsalz (Kochsalz, Konservierungsstoff E250), Gewürze (u.a. SELLERIE), Kräuter, Geschmacksverstärker: Natriumglutamat, Stabilisator: Phosphat",
          name: "Grobe Bauernwurst",
          good_for: 7,
          sizes: [
            {
              labelSize: SMALL,
              weight: W250,
            },
            {
              labelSize: LARGE,
              weight: W300,
            },
          ]
        },
        jagdwurst: {
          prefix: "Hausgemachte",
          ingredients:
            "70% Schweinefleisch, 15% Rindfleisch, Trinkwasser, Nitritpökelsalz (Kochsalz, Konservierungsstoff E250), Gewürze u.a. SELLERIE, Stabilisator: Phosphat, Geschmacksverstärker: Natriumglutamat",
          name: "Jagdwurst",
          good_for: 7,
          sizes: [
            {
              labelSize: SMALL,
              weight: W250,
            },
            {
              labelSize: LARGE,
              weight: W300,
            },
          ]
        },
        leberkaese: {
          prefix: "Hausgemachter",
          ingredients:
            "70% Schweinefleisch, 10% Rindfleisch, Trinkwasser, Nitritpökelsalz (Kochsalz, Konservierungsstoff E 250), Gewürze u.a. SENF; SELLERIE, Geschmacksverstärker: Natriumglutamat, Stabilisator: Phosphat",
          name: "Leberkäse",
          good_for: 7,
          sizes: [
            {
              labelSize: SMALL,
              weight: W250,
            },
            {
              labelSize: LARGE,
              weight: W300,
            },
          ]
        },
        roter_pressack: {
          prefix: "Hausgemachter",
          ingredients:
            "70% Schweinefleisch, Blut, Schwarten, Fleischbrühe, Leber, Nitritpökelsalz (Kochsalz, Konservierungsstoff E250), Gewürze u.a. SELLERIE, Zwiebeln, Kräuter, Geschmacksverstärker: Natriumglutamat",
          name: "Roter Preßsack",
          good_for: 7,
          sizes: [
            {
              labelSize: SMALL,
              weight: W250,
            },
            {
              labelSize: LARGE,
              weight: W300,
            },
          ]
        },
        schinkenwurst: {
          prefix: "Hausgemachte",
          ingredients:
            "65% Schweinefleisch, 15% Rindfleisch, Trinkwasser, Nitritpökelsalz (Kochsalz, Konservierungsstoff E250), Gewürze u.a. SELLERIE,SENF, Stabilisator: Phosphat, Geschmacksverstärker: Natriumglutamat",
          name: "Schinkenwurst",
          good_for: 7,
          sizes: [
            {
              labelSize: SMALL,
              weight: W250,
            },
            {
              labelSize: LARGE,
              weight: W300,
            },
          ]
        },
        schweinefleisch: {
          prefix: "Hausgemachtes",
          ingredients:
            "90% Schweinefleisch, 5% Schwarten, Nitritpökelsalz (Kochsalz, Konservierungsstoff E250), Gewürze u.a. SELLERIE, Geschmacksverstärker: Natriumglutamat",
          name: "Schweinefleisch",
          good_for: 7,
          sizes: [
            {
              labelSize: SMALL,
              weight: W250,
            },
            {
              labelSize: LARGE,
              weight: W300,
            },
          ]
        },
        weisser_pressack: {
          prefix: "Hausgemachter",
          ingredients:
            "70% Schweinefleisch, Schwarten, Fleischbrühe, Leber, Nitritpökelsalz (Kochsalz, Konservierungsstoff E250), Gewürze u.a. SELLERIE, Zwiebeln, Kräuter, Geschmacksverstärker: Natriumglutamat",
          name: "Weißer Preßsack",
          good_for: 7,
          sizes: [
            {
              labelSize: SMALL,
              weight: W200,
            },
            {
              labelSize: LARGE,
              weight: W300,
            },
          ]
        },
        zwiebelmettwurst: {
          prefix: "Hausgemachte",
          ingredients:
            "80% Schweinefleisch, Fleischbrühe, Zwiebeln, Gewürze (u.a. SELLERIE, LACTOSE), Nitritpökelsalz (Kochsalz, Konservierungsstoff E 250), Geschmacksverstärker: Natriumglutamat",
          name: "Zwiebelmettwurst",
          good_for: 7,
          sizes: [
            {
              labelSize: SMALL,
              weight: W250,
            },
          ]
        },
        griebenschmalz: {
          prefix: "Hausgemachtes",
          ingredients:
            "95 % Schweinefett, Grieben, Röstzwiebeln (Weizenmehl, Gluten, pflanz. Öl) Gewürze, Kochsalz",
          name: "Griebenschmalz",
          good_for: 5,
          sizes: [
            {
              labelSize: SMALL,
              weight: W250,
            },
          ]
        },
        schaschliktopf: {
          prefix: "Hausgemachter",
          ingredients:
            "Schweinefleisch, Räucherkamm, Zwiebeln, Paprika, Schaschliksoße enthält SENF, Gewürze",
          name: "Schaschliktopf",
          good_for: 5,
          sizes: [
            {
              labelSize: LARGE,
              weight: W300,
            },
          ]
        },
        zwetschgenbaames: {
          prefix: "",
          ingredients: "Rindfleisch, Salz, Gewürze, Rauch",
          name: "Zwetschgenbaames",
          good_for: 0,
          sizes: [
            {
              labelSize: SMALL,
            },
          ]
         },
      };

      function generatePDF(kind, size) {
        if (kind == "zwetschgenbaames") {
          doc = generateZwetschgenbaamesPdf();
        } else if (size < 300) {
          // Bei Griebenschmalz ist size = 250, es sollen aber kleine Etiketten sein.
          doc = generateSmallPdf(kind, size);
        } else {
          doc = generateLargePdf(kind, size);
        }

        doc.autoPrint();
        window.open(doc.output("bloburl"), "_blank");
      }

      function generateZwetschgenbaamesPdf() {
        let doc = new jsPDF("l", "mm", "a4");

        let width = 90;
        let height = 17;
        let xFirst = 52;
        let yFirst = 24;
        let deltaX = 130;
        let deltaY = 30;

        let kindObject = content["zwetschgenbaames"];
        let fontName = "times";

        for (let i = 0; i < 6; i++) {
          for (let j = 0; j < 2; j++) {
            let currentX = xFirst + deltaX * j;
            let currentY = yFirst + deltaY * i;

            doc.setFont(fontName);
            doc.setFontStyle("bold");
            doc.setFontSize(16);
            doc.text(kindObject["name"], currentX + 25, currentY + 6);

            doc.setFontSize(6);
            doc.setFontStyle("normal");
            doc.text(
              "Zutaten: " + kindObject["ingredients"],
              currentX + 25,
              currentY + 11,
              {
                maxWidth: width,
                lineHeightFactor: 1,
              }
            );
          }
        }

        return doc;
      }

      function generateSmallPdf(kind, size) {
        let doc = new jsPDF("l", "mm", "a4");

        let width = 90;
        let height = 17;
        let xFirst = 52;
        let yFirst = 24;
        let deltaX = 130;
        let deltaY = 30;

        let kindObject = content[kind];
        let fontName = "times";

        for (let i = 0; i < 6; i++) {
          for (let j = 0; j < 2; j++) {
            let currentX = xFirst + deltaX * j;
            let currentY = yFirst + deltaY * i;

            //doc.rect(currentX, currentY, width, height);

            doc.setFont(fontName);
            doc.setFontSize(12);
            doc.text(kindObject["prefix"], currentX, currentY + 4);

            doc.setFont(fontName);
            doc.setFontStyle("bold");
            doc.text(kindObject["name"], currentX + 27, currentY + 4);

            doc.setFont(fontName);
            doc.setFontStyle("normal");
            doc.setFontSize(10);
            doc.text("Füllgewicht", currentX, currentY + 8);

            doc.setFont(fontName);
            doc.setFontStyle("bold");
            doc.text(size + "g", currentX + 18, currentY + 8);

            doc.setFont(fontName);
            doc.setFontStyle("normal");
            doc.text("- EIGENE HERSTELLUNG", currentX + 26, currentY + 8);

            doc.setFontSize(6);
            doc.setFontStyle("normal");
            doc.text(
              "Zutaten: " + kindObject["ingredients"],
              currentX,
              currentY + 11,
              {
                maxWidth: width,
                lineHeightFactor: 1,
              }
            );

            doc.setFontSize(5);
            doc.text(
              "Bei Lagerung unter +8°C mindestens haltbar bis: " +
                calculateDate(kindObject["good_for"]),
              currentX + 45,
              currentY + height - 1,
              {}
            );
          }
        }

        return doc;
      }

      function generateLargePdf(kind, size) {
        let doc = new jsPDF("l", "mm", "a4");

        let width = 90;
        let height = 29;
        let xFirst = 53;
        let yFirst = 23;
        let deltaX = 130;
        let deltaY = 48;

        let kindObject = content[kind];
        let fontName = "times";

        for (let i = 0; i < 4; i++) {
          for (let j = 0; j < 2; j++) {
            let currentX = xFirst + deltaX * j;
            let currentY = yFirst + deltaY * i;

            //doc.rect(currentX, currentY, width, height);

            doc.setFont(fontName);
            doc.setFontSize(17);
            doc.text(kindObject["prefix"], currentX, currentY + 5);

            doc.setFont(fontName);
            doc.setFontStyle("bold");
            doc.text(kindObject["name"], currentX + 38, currentY + 5);

            doc.setFont(fontName);
            doc.setFontStyle("normal");
            doc.setFontSize(12);
            doc.text("Füllgewicht", currentX, currentY + 10);

            doc.setFont(fontName);
            doc.setFontStyle("bold");
            doc.text(size + "g", currentX + 22, currentY + 10);

            doc.setFont(fontName);
            doc.setFontStyle("normal");
            doc.text("- EIGENE HERSTELLUNG", currentX + 32, currentY + 10);

            doc.setFontSize(8);
            doc.setFontStyle("normal");
            doc.text(
              "Zutaten: " + kindObject["ingredients"],
              currentX,
              currentY + 15,
              {
                maxWidth: width,
                lineHeightFactor: 1,
              }
            );

            doc.text(
              "Bei Lagerung unter +8°C mindestens haltbar bis: " +
                calculateDate(kindObject["good_for"]),
              currentX + 20,
              currentY + height - 2,
              {}
            );
          }
        }

        return doc;
      }

      function calculateDate(goodFor) {
        let date = new Date();
        date.setDate(date.getDate() + goodFor * 30);

        let dateString =
          date.getDate() +
          "." +
          (date.getMonth() + 1) +
          "." +
          date.getFullYear();

        return dateString;
      }

      function renderButtons(){
        const TEMPLATE = ({key, size, name}) =>
        `<button
            data-kind="${key}"
            data-size="${size}"
            type="button"
            class="btn btn-info btn-lg btn-block btn-etikett"
          >
            ${name} ${size}g
          </button>`;

          $('#small').append([
            { key: 'test', size: '200', name: 'Foo item' },
          ].map(TEMPLATE).join(''));
      }

      $(document).ready(function () {
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('/sw.js');
        }

        renderButtons();

        $(".btn-etikett").on("click", (event) => {
          let kind = $(event.target).data("kind");
          let size = $(event.target).data("size");
          generatePDF(kind, size);
        });
      });
    </script>
    <script src="thirdparty/jspdf.min.js"></script>
  </body>
</html>
